expression 'Valor de Contrato' =
		let
		     Fonte = Excel.Workbook(File.Contents("C:\Users\JoãoLima\Diretório Padrão\Atlas Inovações - Documentos\Relatórios\Dados\02. Externo\01. AFM Gestão\Equatorial\03 - Risco\03. Valores de Contratos\Valor Contrato Atlas.xlsx"), null, true),
		    Ocorrências_Sheet = Fonte{[Item="Planilha1",Kind="Sheet"]}[Data],
		    #"Cabeçalhos Promovidos" = Table.PromoteHeaders(Ocorrências_Sheet, [PromoteAllScalars=true]),
		    #"Linhas em Branco Removidas" = Table.SelectRows(#"Cabeçalhos Promovidos", each not List.IsEmpty(List.RemoveMatchingItems(Record.FieldValues(_), {"", null}))),
		    #"Erros Substituídos" = Table.ReplaceErrorValues(#"Linhas em Branco Removidas", {{"R$ - MÉDIA REAL", 0}}),
		    #"Linhas Classificadas" = Table.Sort(#"Erros Substituídos",{{"N° do pedido", Order.Ascending}}),
		    #"Coluna Mesclada Inserida" = Table.AddColumn(#"Linhas Classificadas", "Mesclado", each Text.Combine({[Fornecedor], [Unidade]}, ""), type text),
		    #"Tipo Alterado" = Table.TransformColumnTypes(#"Coluna Mesclada Inserida",{{"N° do pedido", type text}}),
		    #"Personalização Adicionada" = Table.AddColumn(#"Tipo Alterado", "Personalizar", each Text.PadStart(Text.From([#"N° do pedido"]), 5, "0"))
		in
		    #"Personalização Adicionada"
	lineageTag: f1e32360-e8b9-431e-ac51-59dd5ec08b4f

	annotation PBI_NavigationStepName = Navegação

	annotation PBI_ResultType = Table

expression 'Status Equatorial' =
		let
		    Fonte = Table.FromRows(Json.Document(Binary.Decompress(Binary.FromText("lZLBTsMwDIZfJep5PMQkNmkILoPb1IMXe8OoSaok3YHX4YCGxFPkxXDSVe3UgcQpjv05/x8nu1211IxkIykkFT3soXl11aJ6ZE02fYJ6SmdkDVW9EBYdaTaC/460Lkgd0HkGge4pNHyEvqcAkU+5u19zZmU1ed8jCp3SzoqRIjHrXkMzcTAvp7PIBikNUc6ORiGSt4yAdOV/ks78ViRC+nCqdV6xZc0gZiF7I9N6OsrtirrhkLl501sXIigNXYBbYNOVnQzhAAKO/rcULqc8uBMZtRQ1i/x+45ABDIL9JffiwYYD+fRl5R75lSfzvS7eqWdI3wj/71vlCg6fxHDkMqEcjk42Fi5vP0R1/QM=", BinaryEncoding.Base64), Compression.Deflate)), let _t = ((type nullable text) meta [Serialized.Text = true]) in type table [Motivo = _t, Status = _t]),
		    #"Tipo Alterado" = Table.TransformColumnTypes(Fonte,{{"Motivo", type text}, {"Status", type text}})
		in
		    #"Tipo Alterado"
	lineageTag: c8bd975b-dbcd-4b4e-b45f-f6c8dd6a2003

	annotation PBI_NavigationStepName = Navegação

	annotation PBI_ResultType = Table

expression 'Documentos Críticos' =
		let
		    Fonte = Sql.Database("atlas-sql-report-production.database.windows.net", "afm-encargos-prod-bi", [Query="/* ===========================================#(lf)   RELATÓRIO DE DOCUMENTOS (DS) x CONTRATO x COMPETÊNCIA#(lf)   Saída:#(lf)   - Id_Contrato#(lf)   - IdContrato_PeriodKey (Id_Contrato + '_' + PeriodKey)#(lf)   - PeriodKey = YYYYMM (mês anterior ao ExpectedUploadAt)#(lf)   - Quantidade de documentos e aprovados por grupo:#(lf)       FGTS, INSS, Salários#(lf)   - Motivo (lista agregada de status: Atrasado / Em Análise / Reprovado / Outro)#(lf)   =========================================== */#(lf)#(lf)DECLARE @currentDate       datetime2        = '2025-12-11T23:59:59';#(lf)DECLARE @organizationId    uniqueidentifier = '41CACAFC-2823-4A1A-A0DB-381A24EB9014';#(lf)#(lf)DECLARE @startDate  datetime2 = '2024-11-01T00:00:00';#(lf)DECLARE @endDateEx datetime2 = '2025-12-11T23:59:59';#(lf)#(lf);WITH#(lf)/* === 1) Base de DocumentSchedule com StatusCalc e PeriodKey === */#(lf)ds_base AS (#(lf)    SELECT#(lf)        c.Id AS ContractId,#(lf)        ds.Id AS DocumentScheduleId,#(lf)        ds.Name AS Documento,#(lf)        ds.ExpectedUploadAt,#(lf)        ds.UploadedAt,#(lf)        ds.IsValidated,#(lf)        ds.RequiresValidation,#(lf)#(lf)        (YEAR(DATEADD(MONTH, -1, ds.ExpectedUploadAt)) * 100#(lf)       + MONTH(DATEADD(MONTH, -1, ds.ExpectedUploadAt))) AS PeriodKey,  -- YYYYMM#(lf)#(lf)        CASE#(lf)            WHEN ds.ExpectedUploadAt < @currentDate#(lf)                 AND (ds.UploadedAt IS NULL OR ds.UploadedAt > @currentDate)#(lf)            THEN 'Atrasado'#(lf)#(lf)            WHEN ds.UploadedAt IS NOT NULL #(lf)                 AND ds.UploadedAt < @currentDate#(lf)                 AND ds.IsValidated = 1#(lf)            THEN 'Aprovado'#(lf)#(lf)            WHEN ds.UploadedAt IS NOT NULL#(lf)                 AND ds.UploadedAt < @currentDate#(lf)                 AND ds.RequiresValidation = 1#(lf)                 AND ds.IsValidated IS NULL#(lf)            THEN 'Em Análise'#(lf)#(lf)            WHEN ds.ExpectedUploadAt < @currentDate#(lf)             AND ds.UploadedAt < @currentDate#(lf)             AND ds.RequiresValidation = 1 #(lf)             AND ds.UploadedAt IS NOT NULL#(lf)             AND ds.ValidatedAt IS NOT NULL#(lf)             AND ds.IsValidated = 0#(lf)            THEN 'Reprovado'#(lf)#(lf)            ELSE 'Outro'#(lf)        END AS StatusCalc#(lf)    FROM DocumentSchedule ds WITH (NOLOCK)#(lf)    INNER JOIN [Document] d               WITH (NOLOCK) ON d.Id = ds.DocumentId#(lf)    INNER JOIN DocumentScheduleContractBI dscBI WITH (NOLOCK) ON dscBI.DocumentScheduleId = ds.Id#(lf)    INNER JOIN [Contract] c               WITH (NOLOCK) ON c.Id = dscBI.ContractId#(lf)    INNER JOIN Building b                 WITH (NOLOCK) ON b.Id = c.BuildingId#(lf)    WHERE#(lf)        b.OrganizationId = @organizationId#(lf)        AND c.Removed = 0#(lf)        AND ds.Removed = 0#(lf)        AND d.Removed = 0#(lf)        AND d.Archived = 0#(lf)        AND ds.ExpectedUploadAt >= @startDate#(lf)        AND ds.ExpectedUploadAt <  @endDateEx#(lf)        AND ds.Name IN (#(lf)            'Comprovante de Recolhimento',#(lf)            'DARF – Documento de Arrecadação de Receitas Federais',#(lf)            'Relatório da Declaração Completa – DCTFWeb',#(lf)            'Recibo de Entrega da Declaração de Débitos e Créditos Tributários Federais Previdenciários – DCTFWeb',#(lf)            'Comprovante Bancário de Pagamento de Salários',#(lf)            'Folha de Pagamento Mensal Analítica',#(lf)            'FGTS - Comprovante de pagamento',#(lf)            'FGTS - Guia de recolhimento (boleto)',#(lf)            'FGTS - RE - Relação de Empregados/Trabalhadores'#(lf)        )#(lf)),#(lf)#(lf)/* === 2) Pendências agregadas por contrato+competência (somente NÃO aprovados) === */#(lf)pend_agg AS (#(lf)    SELECT#(lf)        s.ContractId,#(lf)        s.PeriodKey,#(lf)        STRING_AGG(t.StatusTextLower, '; ')#(lf)            WITHIN GROUP (ORDER BY t.StatusOrder, t.StatusTextLower) AS StatusList#(lf)    FROM (#(lf)        SELECT DISTINCT ContractId, PeriodKey, StatusCalc#(lf)        FROM ds_base#(lf)        WHERE StatusCalc <> 'Aprovado'#(lf)    ) s#(lf)    CROSS APPLY (#(lf)        SELECT#(lf)            CASE s.StatusCalc#(lf)                WHEN 'Atrasado'   THEN 1#(lf)                WHEN 'Em Análise' THEN 2#(lf)                WHEN 'Reprovado'  THEN 3#(lf)                ELSE 99#(lf)            END AS StatusOrder,#(lf)            CASE s.StatusCalc#(lf)                WHEN 'Atrasado'   THEN 'Atrasado'#(lf)                WHEN 'Em Análise' THEN 'Em Análise'#(lf)                WHEN 'Reprovado'  THEN 'Reprovado'#(lf)                ELSE 'Outro'#(lf)            END AS StatusTextLower#(lf)    ) t#(lf)    GROUP BY s.ContractId, s.PeriodKey#(lf))#(lf)#(lf)SELECT#(lf)    d.ContractId                          AS [Id_Contrato],#(lf)    d.PeriodKey,#(lf)    CONCAT(CONVERT(varchar(36), d.ContractId), '_', d.PeriodKey) AS [IdContrato_PeriodKey],#(lf)#(lf)    /* Quantidade de documentos por grupo */#(lf)    COUNT(DISTINCT CASE #(lf)        WHEN d.Documento IN (#(lf)            'FGTS - Comprovante de pagamento',#(lf)            'FGTS - Guia de recolhimento (boleto)',#(lf)            'FGTS - RE - Relação de Empregados/Trabalhadores'#(lf)        ) THEN d.DocumentScheduleId#(lf)    END) AS [FGTS],#(lf)#(lf)    COUNT(DISTINCT CASE #(lf)        WHEN d.Documento IN (#(lf)            'FGTS - Comprovante de pagamento',#(lf)            'FGTS - Guia de recolhimento (boleto)',#(lf)            'FGTS - RE - Relação de Empregados/Trabalhadores'#(lf)        )#(lf)        AND d.UploadedAt IS NOT NULL#(lf)        AND d.UploadedAt < @currentDate#(lf)        AND d.IsValidated = 1#(lf)    THEN d.DocumentScheduleId#(lf)    END) AS [FGTS_Aprovado],#(lf)#(lf)    COUNT(DISTINCT CASE #(lf)        WHEN d.Documento IN (#(lf)            'Comprovante Bancário de Pagamento de Salários',#(lf)            'Folha de Pagamento Mensal Analítica'#(lf)        ) THEN d.DocumentScheduleId#(lf)    END) AS [Salários],#(lf)#(lf)    COUNT(DISTINCT CASE #(lf)        WHEN d.Documento IN (#(lf)            'Comprovante Bancário de Pagamento de Salários',#(lf)            'Folha de Pagamento Mensal Analítica'#(lf)        )#(lf)        AND d.UploadedAt IS NOT NULL#(lf)        AND d.UploadedAt < @currentDate#(lf)        AND d.IsValidated = 1#(lf)    THEN d.DocumentScheduleId#(lf)    END) AS [Salários_Aprovado],#(lf)#(lf)    COUNT(DISTINCT CASE #(lf)        WHEN d.Documento IN (#(lf)            'Comprovante de Recolhimento',#(lf)            'DARF – Documento de Arrecadação de Receitas Federais',#(lf)            'Relatório da Declaração Completa – DCTFWeb',#(lf)            'Recibo de Entrega da Declaração de Débitos e Créditos Tributários Federais Previdenciários – DCTFWeb'#(lf)        ) THEN d.DocumentScheduleId#(lf)    END) AS [INSS],#(lf)#(lf)    COUNT(DISTINCT CASE #(lf)        WHEN d.Documento IN (#(lf)            'Comprovante de Recolhimento',#(lf)            'DARF – Documento de Arrecadação de Receitas Federais',#(lf)            'Relatório da Declaração Completa – DCTFWeb',#(lf)            'Recibo de Entrega da Declaração de Débitos e Créditos Tributários Federais Previdenciários – DCTFWeb'#(lf)        )#(lf)        AND d.UploadedAt IS NOT NULL#(lf)        AND d.UploadedAt < @currentDate#(lf)        AND d.IsValidated = 1#(lf)    THEN d.DocumentScheduleId#(lf)    END) AS [INSS_Aprovado],#(lf)#(lf)    /* Motivo: lista agregada de status (Atrasado, Em Análise, Reprovado, Outro) */#(lf)   ISNULL(p.StatusList,'---') AS [Motivo]#(lf)#(lf)FROM ds_base d#(lf)LEFT JOIN pend_agg p#(lf)       ON p.ContractId = d.ContractId#(lf)      AND p.PeriodKey  = d.PeriodKey#(lf)GROUP BY#(lf)    d.ContractId,#(lf)    d.PeriodKey,#(lf)    p.StatusList#(lf)ORDER BY#(lf)    d.PeriodKey,#(lf)    d.ContractId;#(lf)"])
		in
		    Fonte
	lineageTag: 637bbe1b-7624-4ce8-81fd-798aac355108

	annotation PBI_NavigationStepName = Navegação

	annotation PBI_ResultType = Table

